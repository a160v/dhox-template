---
/**
 * Search Component
 * Client-side search using Fuse.js
 *
 * @features
 * - Cmd+K / Ctrl+K keyboard shortcut
 * - Instant filtering & Keyboard navigation
 * - Glassmorphic design
 */
---

<dialog id="search-modal" class="search-modal">
  <div class="search-container surface-box">
    <header class="search-header">
      <svg
        class="search-icon"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
      <input
        type="text"
        id="search-input"
        class="search-input"
        placeholder="Type to search posts."
        aria-label="Search posts"
        autocomplete="off"
      />
      <button class="close-btn" id="close-search" aria-label="Close">
        <kbd class="kbd-key">ESC</kbd>
      </button>
    </header>

    <div class="search-results" id="search-results"></div>

    <div class="search-footer">
      <div class="shortcut-hint">
        <kbd class="kbd-key">⇅</kbd>
        <span>Navigate</span>
      </div>
      <div class="shortcut-hint">
        <kbd class="kbd-key">↵</kbd>
        <span>Select</span>
      </div>
    </div>
  </div>
</dialog>

<script>
  interface SearchResult {
    title: string;
    description: string;
    slug: string;
    pubDate: string;
    tags: string[];
  }

  // State
  let fuse: any;
  let isIndexLoaded = false;
  let activeIndex = -1;

  // DOM Elements
  let els: {
    input?: HTMLInputElement | null;
    results?: HTMLElement | null;
    modal?: HTMLDialogElement | null;
    closeBtn?: HTMLElement | null;
  } = {};

  async function loadSearchIndex() {
    if (isIndexLoaded) return;
    try {
      const [Data, Fuse] = await Promise.all([
        fetch("/search.json").then((res) => res.json()),
        import("fuse.js").then((mod) => mod.default),
      ]);

      fuse = new Fuse(Data, {
        keys: [
          { name: "title", weight: 1 },
          { name: "tags", weight: 0.8 },
          { name: "description", weight: 0.5 },
        ],
        threshold: 0.3,
        ignoreLocation: true,
      });
      isIndexLoaded = true;
    } catch (e) {
      console.error("Search load error", e);
    }
  }

  function toggleModal(show: boolean) {
    if (!els.modal) return;

    if (show) {
      els.modal.showModal();
      setTimeout(() => els.input?.focus(), 50);
      loadSearchIndex();
    } else {
      els.modal.close();
      if (els.input) els.input.value = "";
      if (els.results) els.results.innerHTML = "";
      activeIndex = -1;
    }
  }

  function renderNoResults() {
    if (els.results) {
      els.results.innerHTML = `<div class="search-placeholder"><p>No results found.</p></div>`;
    }
  }

  function renderResultItem(item: SearchResult, index: number) {
    const tagsHtml =
      item.tags?.length > 0
        ? `<span class="result-tag">#${item.tags[0]}</span>`
        : "";
    const dateStr = new Date(item.pubDate).toLocaleDateString();

    return `
      <a href="${item.slug}" class="search-result-item" data-index="${index}">
        <div class="result-content">
          <h4 class="result-title">${item.title}</h4>
          <div class="result-meta">${tagsHtml}<span class="result-date">${dateStr}</span></div>
        </div>
        <svg class="result-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
      </a>
    `;
  }

  function updateResults(query: string) {
    if (!fuse || !els.results) return;

    if (!query) {
      els.results.innerHTML = "";
      return;
    }

    const results = fuse.search(query);
    if (results.length === 0) return renderNoResults();

    els.results.innerHTML = results
      .map((r: any, i: number) => renderResultItem(r.item, i))
      .join("");

    // Re-attach click listeners
    els.results
      .querySelectorAll(".search-result-item")
      .forEach((link) =>
        link.addEventListener("click", () => toggleModal(false))
      );
  }

  function handleKeyNav(e: KeyboardEvent) {
    const items = els.results?.querySelectorAll(
      ".search-result-item"
    ) as NodeListOf<HTMLElement>;
    if (!items?.length) return;

    if (e.key === "ArrowDown" || e.key === "ArrowUp") {
      e.preventDefault();
      const dir = e.key === "ArrowDown" ? 1 : -1;
      activeIndex = (activeIndex + dir + items.length) % items.length;

      items.forEach((item, i) => {
        const isActive = i === activeIndex;
        item.classList.toggle("active", isActive);
        if (isActive) item.scrollIntoView({ block: "nearest" });
      });
    } else if (e.key === "Enter" && activeIndex >= 0) {
      items[activeIndex].click();
    }
  }

  function handleKeydown(e: KeyboardEvent) {
    // CMD+K or slash to open
    if ((e.metaKey && e.key === "k") || (e.key === "/" && !els.modal?.open)) {
      e.preventDefault();
      toggleModal(true);
    }
    // ESC is handled by dialog natively, but we ensure state cleanup via 'close' listener
  }

  function initSearch() {
    els = {
      input: document.getElementById("search-input") as HTMLInputElement,
      results: document.getElementById("search-results"),
      modal: document.getElementById("search-modal") as HTMLDialogElement,
      closeBtn: document.getElementById("close-search"),
    };

    // Global Listeners (Cleanup first)
    document.removeEventListener("keydown", handleKeydown);
    window.removeEventListener("search:toggle", () => toggleModal(true));

    document.addEventListener("keydown", handleKeydown);
    window.addEventListener("search:toggle", () => toggleModal(true)); // Re-bind

    // Element Listeners
    els.input?.addEventListener("input", (e) =>
      updateResults((e.target as HTMLInputElement).value)
    );
    els.input?.addEventListener("keydown", handleKeyNav);

    els.modal?.addEventListener("click", (e) => {
      if (e.target === els.modal) toggleModal(false);
    });
    els.modal?.addEventListener("close", () => toggleModal(false)); // Cleanup state

    els.closeBtn?.addEventListener("click", () => toggleModal(false));
  }

  initSearch();
  document.addEventListener("astro:page-load", initSearch);

  // Legacy
  (window as any).toggleSearch = () =>
    window.dispatchEvent(new CustomEvent("search:toggle"));
</script>

<style>
  .search-modal {
    padding: 0;
    border: none;
    background: transparent;
    width: 100%;
    height: 100%;
    max-width: 100vw;
    max-height: 100vh;
    margin: 0;
    justify-content: center;
    align-items: flex-start;
    padding-top: 15vh;
    opacity: 0;
    transition:
      opacity 0.2s ease-in-out,
      display 0.2s allow-discrete;
  }

  .search-modal[open] {
    opacity: 1;
    display: flex;
  }

  .search-modal::backdrop {
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    opacity: 0;
    transition:
      opacity 0.2s ease-in-out,
      display 0.2s allow-discrete;
  }

  .search-modal[open]::backdrop {
    opacity: 1;
  }

  @starting-style {
    .search-modal[open],
    .search-modal[open]::backdrop {
      opacity: 0;
    }
  }

  /* Uses .surface-box from global.css but overrides radius */
  .search-container {
    position: relative;
    width: 100%;
    max-width: 600px;
    border-radius: var(--radius-xl); /* Override lg */
    box-shadow: var(--shadow-2xl);
    overflow: hidden;
    transform: scale(0.95);
    transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    display: flex;
    flex-direction: column;
    max-height: 70vh;
    margin: 0 var(--space-4);
  }

  .search-modal[open] .search-container {
    transform: scale(1);
  }

  @starting-style {
    .search-modal[open] .search-container {
      transform: scale(0.95);
    }
  }

  .search-header {
    display: flex;
    align-items: center;
    padding: var(--space-4) var(--space-5);
    border-bottom: 1px solid var(--color-border);
    gap: var(--space-3);
  }

  .search-icon {
    color: var(--color-text-muted);
    flex-shrink: 0;
  }

  .search-input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: var(--text-lg);
    color: var(--color-text);
    outline: none;
    height: 100%;
  }

  .search-input::placeholder {
    color: var(--color-text-muted);
    opacity: 0.7;
  }

  /* Consolidated KBD Styles */
  .kbd-key {
    font-size: var(--text-xs);
    font-family: var(--font-mono);
    padding: 2px 6px;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    color: var(--color-text-muted);
    box-shadow: 0 1px 0 var(--color-border);
    display: inline-block;
    min-width: 16px;
    text-align: center;
  }

  .close-btn {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
  }

  .search-results {
    overflow-y: auto;
    padding: var(--space-2);
  }

  .search-results :global(.search-placeholder) {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 150px;
    color: var(--color-text-muted);
    font-size: var(--text-sm);
  }

  /* Result Items (Global because injected via JS) */
  .search-results :global(.search-result-item) {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: inherit;
    margin-bottom: 2px;
    cursor: pointer;
    transition:
      background-color 0.1s ease,
      border-left 0.1s ease;
    border-left: 3px solid transparent;
  }

  .search-results :global(.search-result-item.active),
  .search-results :global(.search-result-item:hover) {
    background: color-mix(
      in srgb,
      var(--color-accent) 15%,
      var(--color-surface)
    );
    border-left: 3px solid var(--color-accent);
  }

  .search-results :global(.result-title) {
    font-size: var(--text-base);
    font-weight: 500;
    margin: 0 0 2px 0;
    color: var(--color-text);
  }
  .search-results :global(.search-result-item:hover .result-title),
  .search-results :global(.search-result-item.active .result-title) {
    color: var(--color-accent);
  }

  .search-results :global(.result-meta) {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }

  .search-results :global(.result-tag) {
    color: var(--color-accent);
    background: color-mix(in srgb, var(--color-accent) 10%, transparent);
    padding: 1px 6px;
    border-radius: 4px;
  }

  .search-results :global(.result-arrow) {
    color: var(--color-text-muted);
    opacity: 0;
    transition: opacity 0.1s;
  }

  .search-results
    :global(.search-result-item:hover .result-arrow), /* Combined selectors */
  .search-results
    :global(.search-result-item.active .result-arrow) {
    opacity: 1;
  }

  .search-footer {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-2) var(--space-5);
    background: var(--color-bg);
    border-top: 1px solid var(--color-border);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }

  .shortcut-hint {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  @media (max-width: 640px) {
    .search-modal {
      padding-top: 0;
      align-items: flex-end;
    }
    .search-container {
      max-width: 100%;
      height: 90vh;
      max-height: 90vh;
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
      margin: 0;
    }
  }
</style>
