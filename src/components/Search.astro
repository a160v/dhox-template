---
/**
 * Search Component
 * Client-side search using Fuse.js
 *
 * @features
 * - Cmd+K / Ctrl+K keyboard shortcut
 * - Glassmorphic modal design
 * - Instant filtering
 * - Keyboard navigation (Arrow keys, Enter, Esc)
 * - Lazy loading of search index
 */
---

<dialog id="search-modal" class="search-modal">
  <div class="search-container">
    <header class="search-header">
      <svg
        class="search-icon"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
      <input
        type="text"
        id="search-input"
        class="search-input"
        placeholder="Search posts..."
        aria-label="Search posts"
        autocomplete="off"
      />
      <button class="close-btn" id="close-search" aria-label="Close">
        <kbd>ESC</kbd>
      </button>
    </header>
    <div class="search-results" id="search-results">
      <!-- Results injected here -->
      <div class="search-placeholder">
        <p>Type to search...</p>
      </div>
    </div>
    <div class="search-footer">
      <div class="shortcut-hint">
        <kbd class="key">⇅</kbd>
        <span>Navigate</span>
      </div>
      <div class="shortcut-hint">
        <kbd class="key">↵</kbd>
        <span>Select</span>
      </div>
    </div>
  </div>
</dialog>

<script>
  import Fuse from "fuse.js";

  interface SearchResult {
    title: string;
    description: string;
    slug: string;
    pubDate: string;
    tags: string[];
  }

  let fuse: Fuse<SearchResult>;
  // DOM Elements - initialized in initSearch
  let searchInput: HTMLInputElement | null = null;
  let searchResults: HTMLElement | null = null;
  let modal: HTMLDialogElement | null = null;

  let isIndexLoaded = false;
  let activeIndex = -1;

  async function loadSearchIndex() {
    if (isIndexLoaded) return;

    try {
      const response = await fetch("/search.json");
      const list = await response.json();

      fuse = new Fuse(list, {
        keys: [
          { name: "title", weight: 1 },
          { name: "tags", weight: 0.8 },
          { name: "description", weight: 0.5 },
        ],
        threshold: 0.3,
        ignoreLocation: true,
      });

      isIndexLoaded = true;
    } catch (error) {
      console.error("Failed to load search index", error);
    }
  }

  function openSearch() {
    if (!modal || !searchInput) return;
    modal.showModal();
    // Native dialog handles body scroll locking in most modern browsers automatically via ::backdrop
    // but for safety we can add a class if needed. Standard `showModal` prevents interaction outside.

    // Slight delay to ensure visibility before focusing input (though autofocus works too)
    setTimeout(() => {
      searchInput?.focus();
    }, 50);

    loadSearchIndex();
  }

  function closeSearch() {
    if (!modal) return;
    modal.close();
    if (searchInput) searchInput.value = "";
    if (searchResults)
      searchResults.innerHTML =
        '<div class="search-placeholder"><p>Type to search...</p></div>';
    activeIndex = -1;
  }

  function updateResults(query: string) {
    if (!fuse || !searchResults) return;

    if (!query) {
      searchResults.innerHTML =
        '<div class="search-placeholder"><p>Type to search...</p></div>';
      return;
    }

    const results = fuse.search(query);

    if (results.length === 0) {
      searchResults.innerHTML =
        '<div class="search-placeholder"><p>No results found.</p></div>';
      return;
    }

    searchResults.innerHTML = results
      .map(({ item }, index) => {
        return `
        <a href="${item.slug}" class="search-result-item" data-index="${index}">
          <div class="result-content">
            <h4 class="result-title">${item.title}</h4>
            <div class="result-meta">
              ${
                item.tags && item.tags.length > 0
                  ? `<span class="result-tag">#${item.tags[0]}</span>`
                  : ""
              }
              <span class="result-date">${new Date(
                item.pubDate
              ).toLocaleDateString()}</span>
            </div>
          </div>
          <svg class="result-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </a>
      `;
      })
      .join("");
  }

  function handleKeyNavigation(e: KeyboardEvent) {
    const items = document.querySelectorAll(".search-result-item");
    if (items.length === 0) return;

    if (e.key === "ArrowDown") {
      e.preventDefault();
      activeIndex = (activeIndex + 1) % items.length;
      updateActiveItem(items);
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      activeIndex = (activeIndex - 1 + items.length) % items.length;
      updateActiveItem(items);
    } else if (e.key === "Enter" && activeIndex >= 0) {
      (items[activeIndex] as HTMLElement).click();
    }
  }

  function updateActiveItem(items: NodeListOf<Element>) {
    items.forEach((item, index) => {
      if (index === activeIndex) {
        item.classList.add("active");
        item.scrollIntoView({ block: "nearest" });
      } else {
        item.classList.remove("active");
      }
    });
  }

  function handleDocumentKeydown(e: KeyboardEvent) {
    if ((e.metaKey || e.ctrlKey) && e.key === "k") {
      e.preventDefault();
      openSearch();
    }
    if (e.key === "/" && !modal?.open) {
      e.preventDefault();
      openSearch();
    }
    // Escape is handled natively by dialog, but we might want to clean up state
    if (e.key === "Escape" && modal?.open) {
      // closeSearch will be called by 'close' event listener on dialog
    }
  }

  function handleToggleEvent() {
    if (modal?.open) {
      closeSearch();
    } else {
      openSearch();
    }
  }

  function handleInput(e: Event) {
    updateResults((e.target as HTMLInputElement).value);
    activeIndex = -1;
  }

  function handleDialogClick(e: MouseEvent) {
    if (e.target === modal) {
      closeSearch();
    }
  }

  // --- Initialization & Lifecycle ---

  function initSearch() {
    // 1. Refresh DOM references
    searchInput = document.getElementById("search-input") as HTMLInputElement;
    searchResults = document.getElementById("search-results");
    modal = document.getElementById("search-modal") as HTMLDialogElement;
    const closeBtn = document.getElementById("close-search");

    // 2. Cleanup old listeners (to avoid duplicates)
    document.removeEventListener("keydown", handleDocumentKeydown);
    window.removeEventListener("search:toggle", handleToggleEvent);

    // 3. Attach new global listeners
    document.addEventListener("keydown", handleDocumentKeydown);
    window.addEventListener("search:toggle", handleToggleEvent);

    // 4. Attach element-specific listeners
    if (searchInput) {
      searchInput.addEventListener("input", handleInput);
      searchInput.addEventListener("keydown", handleKeyNavigation);
    }

    if (modal) {
      modal.addEventListener("click", handleDialogClick);
      modal.addEventListener("close", () => {
        // Ensure cleanup happens even if closed via Esc or other means
        if (searchInput) searchInput.value = "";
        activeIndex = -1;
      });
    }

    if (closeBtn) {
      closeBtn.addEventListener("click", closeSearch);
    }
  }

  // Initialize on first load
  initSearch();

  // Re-initialize on ViewTransitions navigation
  document.addEventListener("astro:page-load", initSearch);

  // Legacy support & Direct call
  window.toggleSearch = () => {
    window.dispatchEvent(new CustomEvent("search:toggle"));
  };
</script>

<style>
  .search-modal {
    padding: 0;
    border: none;
    background: transparent;
    max-width: 100vw;
    max-height: 100vh;
    width: 100%;
    height: 100%;
    margin: 0;

    /* Flex container for positioning the inner box */
    /* display: flex;  <-- REMOVED: This was overriding native display:none */
    justify-content: center;
    align-items: flex-start;
    padding-top: 15vh;

    /* Animation */
    opacity: 0;
    transition:
      opacity 0.2s ease-in-out,
      display 0.2s ease-in-out allow-discrete;
  }

  /* When open */
  .search-modal[open] {
    opacity: 1;
    display: flex; /* Restore flex display ONLY when open */
  }

  /* Backdrop styles (Native Overlay) */
  .search-modal::backdrop {
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    opacity: 0;
    transition:
      opacity 0.2s ease-in-out,
      display 0.2s ease-in-out allow-discrete;
  }

  .search-modal[open]::backdrop {
    opacity: 1;
  }

  /* Starting styles for animation (Chrome 117+) */
  @starting-style {
    .search-modal[open] {
      opacity: 0;
    }
    .search-modal[open]::backdrop {
      opacity: 0;
    }
  }

  .search-container {
    position: relative;
    width: 100%;
    max-width: 600px;
    background: var(--color-surface);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-2xl);
    border: 1px solid var(--color-border);
    overflow: hidden;
    transform: scale(0.95);
    transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    display: flex;
    flex-direction: column;
    max-height: 70vh;
    /* Ensure it works within flex dialog */
    margin: 0 var(--space-4);
  }

  .search-modal[open] .search-container {
    transform: scale(1);
  }

  @starting-style {
    .search-modal[open] .search-container {
      transform: scale(0.95);
    }
  }

  .search-header {
    display: flex;
    align-items: center;
    padding: var(--space-4) var(--space-5);
    border-bottom: 1px solid var(--color-border);
    gap: var(--space-3);
  }

  .search-icon {
    color: var(--color-text-muted);
    flex-shrink: 0;
  }

  .search-input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: var(--text-lg);
    color: var(--color-text);
    outline: none;
    height: 100%;
  }

  .search-input::placeholder {
    color: var(--color-text-muted);
    opacity: 0.7;
  }

  .kbd-shortcut kbd {
    font-size: var(--text-xs);
    font-family: var(--font-mono);
    padding: 2px 6px;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    color: var(--color-text-muted);
  }

  .search-results {
    overflow-y: auto;
    padding: var(--space-2);
    min-height: 100px;
  }

  .search-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 150px;
    color: var(--color-text-muted);
    font-size: var(--text-sm);
  }

  .search-result-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: inherit;
    margin-bottom: 2px;
    cursor: pointer;
    transition: background-color 0.1s ease;
  }

  .search-result-item.active,
  .search-result-item:hover {
    background: var(--color-bg);
  }

  .search-result-item.active .result-title,
  .search-result-item:hover .result-title {
    color: var(--color-accent);
  }

  .result-title {
    font-size: var(--text-base);
    font-weight: 500;
    margin: 0 0 2px 0;
    color: var(--color-text);
  }

  .result-meta {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }

  .result-tag {
    color: var(--color-accent);
    background: color-mix(in srgb, var(--color-accent) 10%, transparent);
    padding: 1px 6px;
    border-radius: 4px;
  }

  .result-arrow {
    color: var(--color-text-muted);
    opacity: 0;
    transition: opacity 0.1s;
  }

  .search-result-item.active .result-arrow,
  .search-result-item:hover .result-arrow {
    opacity: 1;
  }

  .search-footer {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-2) var(--space-5);
    background: var(--color-bg);
    border-top: 1px solid var(--color-border);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }

  .shortcut-hint {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .shortcut-hint .key {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 2px;
    padding: 0 4px;
    font-family: var(--font-mono);
    min-width: 16px;
    text-align: center;
    box-shadow: 0 1px 0 var(--color-border);
  }

  @media (max-width: 640px) {
    .search-modal {
      padding-top: 0;
      align-items: flex-end;
    }

    .search-container {
      max-width: 100%;
      height: 90vh;
      max-height: 90vh;
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    }
  }
</style>
