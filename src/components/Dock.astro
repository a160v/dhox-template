---
/**
 * Dock Component
 * macOS-style navigation dock at bottom of screen
 *
 * @features
 * - App-style colored icons with gradients
 * - CSS Mask icons for crisp rendering (no pixelation)
 * - Active indicator dots
 * - Hover animations (magnification)
 * - ViewTransitions persistence
 *
 * TABLE OF CONTENTS
 * -----------------
 * 1. Imports & Config
 * 2. Component Logic (Active state check)
 * 3. HTML Template
 * 4. Styles (Glassmorphism, Gradients, Masks)
 * 5. Scripts (Active state updates)
 *
 * @usage
 * <Dock />
 */
import { SITE_CONFIG } from "../consts";
import AnalogueClock from "./AnalogueClock.astro";

const currentPath = Astro.url.pathname;

interface DockItem {
  href: string;
  label: string;
  imgSrc: string;
}

const dockItems: DockItem[] = [
  { href: "/", label: "Home", imgSrc: "/home.svg" },
  { href: "/about", label: "About", imgSrc: "/person.svg" },
  { href: "/blog", label: "Blog", imgSrc: "/pencil-2.svg" },
  {
    href: `mailto:${SITE_CONFIG.author.email}`,
    label: "Email",
    imgSrc: "/chat-bubble.svg",
  },
];

/**
 * Check if a dock item is active based on current path
 * @param {string} href - The link of the dock item
 * @returns {boolean} - True if active
 */
function isActive(href: string): boolean {
  if (href === "/") {
    return currentPath === "/";
  }
  return currentPath.startsWith(href);
}
---

<nav class="dock" id="dock">
  <div class="dock-container">
    {
      dockItems.map((item) => (
        <a
          href={item.href}
          class:list={["dock-item", { active: isActive(item.href) }]}
          aria-label={item.label}
        >
          <span class="dock-icon">
            <span
              class="nav-icon"
              style={`mask-image: url(${item.imgSrc}); -webkit-mask-image: url(${item.imgSrc});`}
            />
          </span>
        </a>
      ))
    }
    <!-- {
      (
        /* Analogue Clock */
        <div
          class="clock-dock-item"
          aria-label="Central European Time"
          title="Central European Time"
        >
          <AnalogueClock />
        </div>
      )
    } -->
    {
      (
        /* Search Action (Global) */
        <button class="dock-item search-dock-btn" aria-label="Search">
          <span class="dock-icon">
            <span
              class="nav-icon"
              style="mask-image: url(/search.svg); -webkit-mask-image: url(/search.svg);"
            />
          </span>
        </button>
      )
    }
  </div>
</nav>

<style>
  .dock {
    position: fixed;
    bottom: var(--space-6);
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
  }

  .dock-container {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2);
    background: var(--dock-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--dock-border);
    border-radius: 16px;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
  }

  .dock-item {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    border-radius: 12px;
    color: white;
    text-decoration: none;
    transition:
      transform var(--transition-base),
      box-shadow var(--transition-base);
    background: linear-gradient(135deg, #8e8e93, #636366);
    border: none;
    cursor: pointer;
    font-family: inherit;
    position: relative;
    padding: 0;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
  }

  /* App Gradients */
  :global(a[href="/"].dock-item) {
    background: linear-gradient(180deg, #30d2ff 0%, #007aff 100%);
  }
  :global(a[href="/about"].dock-item) {
    background: linear-gradient(180deg, #ff9f0a 0%, #ff6b00 100%);
  }
  :global(a[href="/blog"].dock-item) {
    background: linear-gradient(180deg, #bf5af2 0%, #5e5ce6 100%);
  }
  :global(a[href^="mailto"].dock-item) {
    background: linear-gradient(180deg, #34c759 0%, #30b0c7 100%);
  }

  /* Search Item (only on blog) */
  :global(button.dock-item.search-dock-btn) {
    background: linear-gradient(180deg, #32ade6 0%, #007aff 100%);
  }

  /* Clock Item */
  .clock-dock-item {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    padding: 0;
    border-radius: 12px;
    background: transparent; /* Clock has its own bg */
    border: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    transition:
      transform var(--transition-base),
      box-shadow var(--transition-base);
    cursor: default;
  }

  @media (hover: hover) {
    .clock-dock-item:hover {
      transform: scale(1.15) translateY(-5px);
      z-index: 10;
      box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
    }

    .dock-item:hover {
      transform: scale(1.15) translateY(-5px);
      z-index: 10;
    }
  }

  /* Active state for touch feedback */
  .dock-item:active,
  .clock-dock-item:active {
    transform: scale(0.95);
  }

  /* Active Indicator Dot */
  .dock-item::after {
    content: "";
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 4px;
    background: var(--color-text);
    border-radius: 50%;
    opacity: 0;
    transition: opacity var(--transition-base);
  }

  .dock-item.active::after {
    opacity: 1;
  }

  .dock-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
  }

  /* Icons using CSS Masks for crisp rendering */
  .nav-icon {
    display: block;
    width: 100%;
    height: 100%;
    background-color: white;
    mask-repeat: no-repeat;
    mask-position: center;
    mask-size: contain;
    -webkit-mask-repeat: no-repeat;
    -webkit-mask-position: center;
    -webkit-mask-size: contain;
  }

  /* Mobile */
  @media (max-width: 480px) {
    .dock {
      bottom: var(--space-6); /* Lift up slightly for better ergonomics */
    }
    .dock-container {
      gap: var(--space-2);
      padding: var(--space-3); /* Slightly larger padding */
    }
    .dock-item,
    .clock-dock-item {
      width: 52px; /* Enlarge to fill ~75% of typical mobile width (390px * 0.75 â‰ˆ 292px) */
      height: 52px;
      border-radius: 14px;
    }

    .dock-icon {
      width: 26px; /* Scale icon content proportionally */
      height: 26px;
    }
  }
</style>

<script>
  /**
   * Initialize Dock
   * Only needed for the Search button listener
   */
  function initDock() {
    // Attach Search Listener
    const searchBtn = document.querySelector(".search-dock-btn");
    if (searchBtn) {
      // Clone to remove old listeners (simplest way to prevent duplicates)
      const newBtn = searchBtn.cloneNode(true);
      searchBtn.parentNode?.replaceChild(newBtn, searchBtn);

      newBtn.addEventListener("click", () => {
        window.dispatchEvent(new CustomEvent("search:toggle"));
      });
    }
  }

  // Run on initial load
  initDock();

  // Re-run on ViewTransitions navigation
  document.addEventListener("astro:page-load", initDock);
</script>
