---
// Apple-style bottom dock navigation
import { SITE_CONFIG } from "../consts";

const currentPath = Astro.url.pathname;

interface DockItem {
  href: string;
  label: string;
  imgSrc: string;
}

const dockItems: DockItem[] = [
  { href: "/", label: "Home", imgSrc: "/home.svg" },
  { href: "/about", label: "About", imgSrc: "/person.svg" },
  { href: "/blog", label: "Blog", imgSrc: "/pencil-2.svg" },
  {
    href: `mailto:${SITE_CONFIG.author.email}`,
    label: "Email",
    imgSrc: "/chat-bubble.svg",
  },
];

function isActive(href: string): boolean {
  if (href === "/") {
    return currentPath === "/";
  }
  return currentPath.startsWith(href);
}
---

<nav class="dock" id="dock" transition:persist>
  <div class="dock-container">
    {
      dockItems.map((item) => (
        <a
          href={item.href}
          class:list={["dock-item", { active: isActive(item.href) }]}
          aria-label={item.label}
        >
          <span class="dock-icon">
            <img
              src={item.imgSrc}
              alt={item.label}
              class="nav-icon"
              width="24"
              height="24"
            />
          </span>
        </a>
      ))
    }

    <div class="separator"></div>

    <div class="dock-extras">
      <!-- Theme Cycler Button (Light → Reader → Dark → Light...) -->
      <button
        class="dock-item theme-toggle"
        id="theme-toggle"
        aria-label="Change theme"
      >
        <span class="dock-icon">
          <!-- Sun icon for Light mode -->
          <img
            src="/sun.svg"
            alt="Light mode"
            class="theme-icon"
            id="icon-light"
            width="24"
            height="24"
          />
          <!-- Eye icon for Reader/Sepia mode -->
          <img
            src="/eye-open.svg"
            alt="Reader mode"
            class="theme-icon"
            id="icon-sepia"
            width="24"
            height="24"
          />
          <!-- Moon icon for Dark mode -->
          <img
            src="/moon.svg"
            alt="Dark mode"
            class="theme-icon"
            id="icon-dark"
            width="24"
            height="24"
          />
        </span>
      </button>

      <!-- Font Switcher Button -->
      <button
        class="dock-item font-toggle"
        id="font-toggle"
        aria-label="Change font"
      >
        <span class="dock-icon">
          <img
            src="/font-style.svg"
            alt="Font style"
            class="nav-icon"
            width="24"
            height="24"
          />
        </span>
      </button>
    </div>
  </div>
</nav>

<style>
  .dock {
    position: fixed;
    bottom: var(--space-6);
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    transition:
      transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      opacity 0.3s ease;
  }

  .dock.hidden {
    transform: translateX(-50%) translateY(calc(100% + var(--space-8)));
    opacity: 0;
  }

  .dock-container {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-2) var(--space-3);
    background: var(--dock-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--dock-border);
    border-radius: 20px; /* macOS style radius */
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
  }

  .separator {
    width: 1px;
    height: 32px;
    background-color: var(--color-text);
    margin: 0 var(--space-1);
    opacity: 0.1;
  }

  .dock-extras {
    display: flex;
    gap: var(--space-3);
  }

  .dock-item {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    border-radius: 12px; /* Squaricle */
    color: white; /* Icons are always white inside color blocks */
    text-decoration: none;
    transition:
      transform var(--transition-base),
      box-shadow var(--transition-base);
    background: linear-gradient(135deg, #8e8e93, #636366); /* Default grey */
    border: none;
    cursor: pointer;
    font-family: inherit;
    position: relative;
    padding: 0;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
  }

  /* Specific App Gradients */
  :global(a[href="/"].dock-item) {
    background: linear-gradient(
      180deg,
      #30d2ff 0%,
      #007aff 100%
    ); /* Finder Blue */
  }
  :global(a[href="/about"].dock-item) {
    background: linear-gradient(
      180deg,
      #ff9f0a 0%,
      #ff6b00 100%
    ); /* Warm Orange */
  }
  :global(a[href="/blog"].dock-item) {
    background: linear-gradient(
      180deg,
      #bf5af2 0%,
      #5e5ce6 100%
    ); /* Purple/Indigo */
  }
  :global(a[href^="mailto"].dock-item) {
    background: linear-gradient(
      180deg,
      #34c759 0%,
      #30b0c7 100%
    ); /* Green/Teal */
  }

  /* Settings Icons (Theme/Font) */
  :global(.dock-item.theme-toggle),
  :global(.dock-item.font-toggle) {
    background: linear-gradient(
      180deg,
      #636366 0%,
      #2c2c2e 100%
    ); /* System Grey */
  }

  .dock-item:hover {
    transform: scale(1.15) translateY(-5px);
    z-index: 10;
  }

  .dock-item.active {
    /* bg handled by gradient */
  }

  /* Active Indicator Dot */
  .dock-item.active::after {
    content: "";
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 4px;
    background-color: var(--color-text);
    border-radius: 50%;
    opacity: 0.6;
  }

  /* Navigation icons color adaptation */
  .nav-icon {
    box-sizing: border-box;
    padding: 8px; /* Room inside the squaricle */
    width: 100%;
    height: 100%;
    transition: filter var(--transition-base);
    filter: invert(1) brightness(10); /* Force White Icons everywhere */
  }

  /* Theme icons needs to be white too inside grey blocks */
  .theme-icon {
    position: absolute;
    opacity: 0;
    transition:
      transform var(--transition-spring),
      opacity var(--transition-base);
    transform: scale(0.5);
    width: 100%;
    height: 100%;
    padding: 10px;
    filter: invert(1) brightness(10);
  }

  /* In dark mode, icons are already white, but the filters above force it. 
     We need to ensure content is white regardless of theme because backgrounds are colored. */
  :global([data-theme="dark"]) .nav-icon,
  :global([data-theme="dark"]) .theme-icon {
    filter: invert(1) brightness(10);
  }

  /* Except light mode... svg's are likely black. 
     invert(1) makes them white. 
     So we always want invert(1) on these black SVGs. */

  .dock-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    transition: transform var(--transition-spring);
    position: relative;
  }

  .theme-icon.visible {
    opacity: 1;
    transform: scale(1);
  }

  /* Responsive - keep same design on mobile as it's compact now */
  @media (max-width: 480px) {
    .dock-container {
      padding: var(--space-2);
      border-radius: 16px;
      gap: var(--space-2);
    }
    .dock-item {
      width: 40px;
      height: 40px;
      border-radius: 10px;
    }
  }
</style>

<script>
  // Theme cycle: Light → Sepia (Reader) → Dark → Light...
  const themeCycle = ["light", "sepia", "dark"] as const;
  type Theme = (typeof themeCycle)[number];

  function getStoredTheme(): Theme {
    const stored = localStorage.getItem("theme") as Theme | null;
    if (stored && themeCycle.includes(stored)) return stored;
    return "light"; // Default to light
  }

  function setTheme(theme: Theme) {
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem("theme", theme);
    updateThemeIcon(theme);
  }

  function updateThemeIcon(theme: Theme) {
    // Hide all icons
    document.querySelectorAll(".theme-icon").forEach((icon) => {
      icon.classList.remove("visible");
    });

    // Show the icon for current theme
    const activeIcon = document.getElementById(`icon-${theme}`);
    activeIcon?.classList.add("visible");
  }

  function cycleTheme() {
    const currentTheme = getStoredTheme();
    const currentIndex = themeCycle.indexOf(currentTheme);
    const nextIndex = (currentIndex + 1) % themeCycle.length;
    const nextTheme = themeCycle[nextIndex];
    setTheme(nextTheme);
  }

  // --- Font Logic ---
  const fontCycle = ["default", "creative", "futuristic"] as const;
  type Font = (typeof fontCycle)[number];

  function getStoredFont(): Font {
    const stored = localStorage.getItem("font") as Font | null;
    if (stored && fontCycle.includes(stored)) return stored;
    return "default";
  }

  function setFont(font: Font) {
    if (font === "default") {
      document.documentElement.removeAttribute("data-font");
    } else {
      document.documentElement.setAttribute("data-font", font);
    }
    localStorage.setItem("font", font);
  }

  function cycleFont() {
    const currentFont = getStoredFont();
    const currentIndex = fontCycle.indexOf(currentFont);
    const nextIndex = (currentIndex + 1) % fontCycle.length;
    const nextFont = fontCycle[nextIndex];
    setFont(nextFont);
  }

  // Initialize Dock - called on page load and ViewTransitions navigation
  function initDock() {
    // Initialize theme and icon
    const initialTheme = getStoredTheme();
    setTheme(initialTheme);

    // Initialize font
    const initialFont = getStoredFont();
    setFont(initialFont);

    // Theme toggle button - cycles through themes on click
    const themeToggle = document.getElementById("theme-toggle");
    themeToggle?.addEventListener("click", cycleTheme);

    // Font toggle button
    const fontToggle = document.getElementById("font-toggle");
    fontToggle?.addEventListener("click", cycleFont);

    // Dock hide/show on scroll
    let lastScrollY = window.scrollY;
    const dock = document.getElementById("dock");

    window.addEventListener(
      "scroll",
      () => {
        const currentScrollY = window.scrollY;

        if (currentScrollY > lastScrollY && currentScrollY > 100) {
          dock?.classList.add("hidden");
        } else {
          dock?.classList.remove("hidden");
        }

        lastScrollY = currentScrollY;
      },
      { passive: true }
    );
  }

  // Run on initial load
  initDock();

  // Re-run on ViewTransitions navigation
  document.addEventListener("astro:page-load", initDock);
</script>
