---
/**
 * BaseLayout
 * The root layout template for all pages
 *
 * @features
 * - HEAD Setup: Meta tags, SEO, OpenGraph, Twitter Cards
 * - Theme Initialization (script to prevent FOUC)
 * - Accessibility: Skip link, semantic HTML structure
 * - ViewTransitions integration
 * - Core styles import (global.css)
 * - Global Dock component integration
 *
 * @usage
 * <BaseLayout title="Page Title" description="Page Desc">
 *   <slot />
 * </BaseLayout>
 */

import Dock from "../components/Dock.astro";
import Search from "../components/Search.astro";
import "../styles/global.css";

interface Props {
  title: string;
  description: string;
  ogImage?: string;
}

const { title, description, ogImage } = Astro.props;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />

    <!-- SEO -->
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />

    <!-- Fonts (Preloaded to prevent FOUC/Chains) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&display=swap"
      rel="stylesheet"
    />

    <!-- RSS & Sitemap -->
    <link
      rel="alternate"
      type="application/rss+xml"
      title="RSS Feed"
      href="/rss.xml"
    />
    <link rel="sitemap" type="application/xml" href="/sitemap-index.xml" />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    {ogImage && <meta property="og:image" content={ogImage} />}

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Prevent FOUC for themes -->
    <script is:inline>
      (function () {
        // Initialize theme
        const theme = localStorage.getItem("theme");
        if (theme) {
          document.documentElement.setAttribute("data-theme", theme);
        } else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
          document.documentElement.setAttribute("data-theme", "dark");
        }
      })();
    </script>
    <slot name="head" />
  </head>
  <body>
    <!-- Skip link for keyboard navigation -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <slot />
    <Search />
    <Dock />

    <!-- Scroll reveal animation - re-runs on ViewTransitions navigation -->
    <script>
      function initReveal() {
        const observerOptions = {
          root: null,
          rootMargin: "50px 0px -10% 0px",
          threshold: 0.01,
        };

        const observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              const target = entry.target as HTMLElement;
              const delay = parseInt(target.dataset.revealDelay || "0");
              setTimeout(() => {
                target.classList.add("revealed");
              }, delay);
              observer.unobserve(target);
            }
          });
        }, observerOptions);

        const elements = document.querySelectorAll(".reveal:not(.revealed)");
        elements.forEach((el, index) => {
          (el as HTMLElement).dataset.revealDelay = String(index * 80);
          observer.observe(el);
        });
      }

      // Run on initial load
      initReveal();

      // Re-run on ViewTransitions navigation
      document.addEventListener("astro:page-load", initReveal);
    </script>
  </body>
</html>
